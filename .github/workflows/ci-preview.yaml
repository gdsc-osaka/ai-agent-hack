name: Deploy Preview Environment

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'web/**'
      - '.github/workflows/ci-preview.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  GCP_PROJECT_ID: 'recall-you'
  GCP_REGION: 'asia-northeast1'
  GCP_SERVICE_ACCOUNT: 'github-action-994212429@recall-you.iam.gserviceaccount.com'
  GCP_WORKLOAD_IDENTITY_PROVIDER: 'projects/966744275445/locations/global/workloadIdentityPools/gh-pool/providers/gh-repo-provider'
  REPO_NAME: 'cloud-run-source-deploy'
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/ci-preview.yaml'
            web:
              - 'web/**'
              - '.github/workflows/ci-preview.yaml'
  backend:
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # OIDCË™çË®º„Å´ÂøÖË¶Å
      pull-requests: 'write' # PR„Å∏„ÅÆ„Ç≥„É°„É≥„Éà„Å´ÂøÖË¶Å
    outputs:
      preview_url: ${{ steps.comment.outputs.PREVIEW_URL }}
      service_name: ${{ steps.comment.outputs.SERVICE_NAME }}
    defaults:
      run:
        working-directory: backend
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # env
      - name: Setting Environment Variables
        run: |
          echo "IMAGE_TAG_API=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-api-preview:${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_TAG_DB=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-db-preview:${{ github.sha }}" >> $GITHUB_ENV
          echo "SERVICE_NAME=recall-you-api-preview-pr-${{ github.event.number }}" >> $GITHUB_ENV
      # Build
      - name: Build and Push API Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.preview.api
          tags: ${{ env.IMAGE_TAG_API }}
          push: true
          cache-from: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-api-preview:cache
          cache-to: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-api-preview:cache,mode=max
      - name: Build and Push DB Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.preview.db
          tags: ${{ env.IMAGE_TAG_DB }}
          push: true
          cache-from: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-db-preview:cache
          cache-to: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-db-preview:cache,mode=max
      # Deploy
      - name: Deploy to Cloud Run
        run: |
          PR_NUMBER=${{ github.event.number }}
          
          gcloud run deploy $SERVICE_NAME \
            --project=${{ env.GCP_PROJECT_ID }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --labels="preview-env=true,created-at=$(date +%s),pr-number=$PR_NUMBER" \
            --container api \
              --image=$IMAGE_TAG_API \
              --port=8080 \
              --set-env-vars="NODE_ENV=production" \
              --set-env-vars="PULL_REQUEST_NUMBER=$PR_NUMBER" \
              --set-env-vars="DATABASE_URL=postgresql://user:password@localhost:5432/db" \
              --set-secrets="FIRE_SA=FIRE_SA:latest" \
              --set-env-vars="AUTH_SECRET=${{ secrets.AUTH_SECRET }}" \
              --set-env-vars="AUTH_DATABASE_URL=postgresql://user:password@localhost:5432/auth_db" \
              --set-env-vars="TRUSTED_ORIGIN_WEB=https://recall-you-*.web.app" \
            --container db \
              --image=$IMAGE_TAG_DB \
              --set-env-vars="PULL_REQUEST_NUMBER=$PR_NUMBER" \
              --set-env-vars="POSTGRES_USER=user" \
              --set-env-vars="POSTGRES_PASSWORD=password" \
              --set-env-vars="POSTGRES_DB=db" \
              --memory=1Gi
      - name: Get Preview URL and Comment on PR
        id: comment
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --platform managed --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "PREVIEW_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_OUTPUT

          COMMENT_TAG="<!-- PREVIEW_URL_COMMENT -->"
          COMMENT_BODY="üöÄ Preview API Server is ready! URL: $SERVICE_URL $COMMENT_TAG"          
          EXISTING_COMMENT=$(gh pr view ${{ github.event.number }} --json comments -q '.comments[] | select(.body | contains("<!-- PREVIEW_URL_COMMENT -->"))')
          # „Ç≥„É°„É≥„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅÊñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
          if [ -z "$EXISTING_COMMENT" ]; then
            gh pr comment ${{ github.event.number }} --body-file - <<< "$COMMENT_BODY"
          else
            echo "Preview URL comment already exists."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Deploy to Firebase Hosting
  web:
    needs: [check-changes, backend]
    defaults:
      run:
        working-directory: web
    if: always() && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: 'read'
      id-token: 'write' # OIDCË™çË®º„Å´ÂøÖË¶Å
      pull-requests: 'write'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      # env
      - name: Setting Environment Variables
        run: |
          echo "IMAGE_TAG_WEB=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-web-preview:${{ github.sha }}" >> $GITHUB_ENV
          echo "SERVICE_NAME=recall-you-web-preview-pr-${{ github.event.number }}" >> $GITHUB_ENV
      # Build
      - name: Geenrate .env
        run: |
          echo "NODE_ENV=production" > .env.local
          echo "API_URL=${{ needs.backend.outputs.preview_url }}" >> .env.local
          echo "AUTH_SECRET=${{ secrets.AUTH_SECRET }}" >> .env.local
      - name: Build and Push Web Image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile.preview.web
          tags: ${{ env.IMAGE_TAG_WEB }}
          push: true
          cache-from: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-web-preview:cache
          cache-to: type=registry,ref=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/recall-you-web-preview:cache,mode=max
      # Deploy
      - name: Deploy to Cloud Run
        run: |
          PR_NUMBER=${{ github.event.number }}
          
          gcloud run deploy $SERVICE_NAME \
            --project=${{ env.GCP_PROJECT_ID }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --labels="preview-env=true,created-at=$(date +%s),pr-number=$PR_NUMBER" \
            --container web \
              --image=$IMAGE_TAG_WEB \
              --port=3000 \
              --set-env-vars="PULL_REQUEST_NUMBER=$PR_NUMBER"
      - name: Get Preview URL and Comment on PR
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --platform managed --region ${{ env.GCP_REGION }} --format 'value(status.url)')

          COMMENT_TAG="<!-- PREVIEW_API_URL_COMMENT -->"
          COMMENT_BODY="üöÄ Preview Web Server is ready! URL: $SERVICE_URL $COMMENT_TAG"          
          EXISTING_COMMENT=$(gh pr view ${{ github.event.number }} --json comments -q '.comments[] | select(.body | contains("<!-- PREVIEW_API_URL_COMMENT -->"))')
          # „Ç≥„É°„É≥„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅÊñ∞„Åó„ÅÑ„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
          if [ -z "$EXISTING_COMMENT" ]; then
            gh pr comment ${{ github.event.number }} --body-file - <<< "$COMMENT_BODY"
          else
            echo "Preview API URL comment already exists."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Overwrite rewrites on firebase.json
        run: |
          sed -i "s/recall-you-api-preview/${{ needs.backend.outputs.service_name }}/g" firebase.json
          sed -i "s/recall-you-web-preview/$SERVICE_NAME/g" firebase.json
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_RECALL_YOU }}
          projectId: recall-you
          expires: '3d'
          entryPoint: 'web'
